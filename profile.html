<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPD CRM - Profile</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 2rem; max-width:800px; margin:0 auto; }
    pre { background:#f4f4f4; padding:1rem; border-radius:6px; }
    a.button { display:inline-block; padding:0.5rem 1rem; background:#0078D4; color:#fff; text-decoration:none; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Profile — Authenticated</h1>
  <p id="welcome">Loading user info…</p>
  <h3>Full claims (debug):</h3>
  <pre id="userjson">Loading…</pre>
  <p><a class="button" href="/.auth/logout">Sign out</a></p>

  <script>
    async function loadUser() {
      try {
        const r = await fetch('/.auth/me', { cache: 'no-store' });
        if (!r.ok) {
          document.getElementById('welcome').textContent = 'Not authenticated.';
          document.getElementById('userjson').textContent = '';
          return;
        }
        const arr = await r.json();
        if (!Array.isArray(arr) || arr.length === 0) {
          document.getElementById('welcome').textContent = 'Not authenticated.';
          document.getElementById('userjson').textContent = '';
          return;
        }
        const user = arr[0];
        const name = (user.user_claims && (user.user_claims.find(c => c.typ === 'name')?.val || user.user_claims.find(c => c.typ === 'preferred_username')?.val)) || user.user_id || 'User';
        document.getElementById('welcome').textContent = `Hello, ${name}! You are authenticated.`;
        document.getElementById('userjson').textContent = JSON.stringify(user, null, 2);
      } catch (e) {
        document.getElementById('welcome').textContent = 'Error loading user info.';
        document.getElementById('userjson').textContent = e.toString();
      }
    }
    loadUser();
  </script>
</body>
</html>
